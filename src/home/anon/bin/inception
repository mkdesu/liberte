#!/bin/sh

title="UNSAFE Virtualized LibertÃ©"
mem=128M
bootdir=/mnt/cdrom/liberte/boot

cdrom="if=virtio,format=raw,media=cdrom,aio=native,cache=none"

params="looptype=noloop loop=/etc/hosts cdroot
        cdroot_type=squashfs unionfs nopata nosata nousb
        video=uvesafb:800x600-32,mtrr:3,ywrap quiet
        splash=silent,theme:liberte console=tty1"

export QEMU_AUDIO_DRV=alsa


if [ -n "$1" ]; then
    bootdir="$1"
    shift
fi

if [ ! -d "${bootdir}" ]; then
    echo "Error:  ${bootdir} not found (already virtualized?)"
    echo "Format: $0 [bootdir] [extra kernel params]"
    exit 1
fi


kvm=
if [ ! -e /dev/kvm ]; then
    vmflag=`grep '^flags\>' /proc/cpuinfo | egrep -o '\<(vmx|svm)\>' | uniq`
    if [ "${vmflag}" = vmx ]; then
        sudo modprobe kvm-intel
    elif [ "${vmflag}" = svm ]; then
        sudo modprobe kvm-amd
    else
        kvm="-no-kvm -cpu qemu32"
    fi
fi


# TODO: add "-device virtio-rng" once it's supported by QEMU
exec qemu-kvm ${kvm} -name "${title}" -m ${mem}    \
    -nodefaults -sdl -monitor vc -balloon virtio   \
    -vga std -soundhw es1370 -net nic,model=virtio -net user \
    -kernel "${bootdir}/kernel-x86.zi"             \
    -initrd "${bootdir}/initrd-x86.lzm"            \
    -drive file="${bootdir}/root-x86.sfs,${cdrom}" \
    -append "`echo ${params} $*`"
