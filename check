#!/bin/sh

export LC_ALL=C


sinfo() {
    echo ${BASH:+-e} "\033[1;33;41m$@\033[0m"
}


# Must have root directory as an argument
if [ -z "$1" ]; then
    echo "$0 <livecd root>"
    exit 1
fi


# Variables
SRC=`dirname $0`
LIVECD=$1/copy
FIND="chroot ${LIVECD} find / -xdev"


if [ -n "${BASH}" ]; then
    check_shlib() {
        local acc=
        for f in $*; do
            if [ -z "${f/#${acc}*/}" ]; then
                acc=${f}
            else
                echo "${f/#${LIVECD}/}"
            fi
        done
    }
else
    check_shlib() { :; }
fi


sinfo "Checking ${LIVECD}"

sinfo "Invalid files and symlinks:"
${FIND} ! \( -type d -o -type f -o -type l \
             -o \( -path '/dev/*' -a \( -type c -o -type b \) \) \)
${FIND} -type l ! -xtype f ! -xtype d

sinfo "Archives:"
${FIND} \( -name '*.gz' -o -name '*.bz2' -o -name '*.Z' \
           -o -name '*.lzma' -o -name '*.xz' \)

sinfo "Sources:"
${FIND} -name '*.h' -o \( -name '*.inc' ! -path '/usr/share/keymaps/*' \) \
        -o -name '*.c' -o -name '*.cpp' \
        -o -name '*.m4' -o -name '*.el' -o -name '*.py' \
        -o -name '*.defs' -o -name '*.pl' -o -name '*.pm'

sinfo "Objects:"
${FIND} -name '*.o' -o -name '*.a' -o -name '*.pc' \
        -o \( -name '*.la' ! -path '/usr/lib/GraphicsMagick-*' \
                           ! -path '/usr/lib/scim-*' \)

sinfo "Duplicate libraries:"
for lib in `${FIND} -name 'lib*.so'`; do
    check_shlib ${LIVECD}${lib}*
done

sinfo "Docs:"
${FIND} \( -name '*.info*' ! -path '/usr/lib/aspell*.info' \) \
        -o -name '*.htm*' -o -name '*.1.bz2'

sinfo "Hidden:"
${FIND} -name '.*' ! \( -path '/home/anon/*' -o -path '/root/*' \) \
        ! -path '/usr/share/gnumeric/*.category'

sinfo "Cache, backup, and temp:"
${FIND} -name '*.cache'
${FIND} -name '*~*' -o -name '*-' -o -name '*#*' -o -name '*.bak' \
        -o -name '*;*' -o -name '*.orig' \
        -o \( -path '*/tmp/*' ! -path '*/tmp/packages/*' \)

sinfo "Logs:"
${FIND} -name '*.log*' -o -type f \( -path '/var/run/*' -o -path '/var/log/*' \)

sinfo "SUID/SGID:"
${FIND} -type f -perm /u+s      -printf '%M %u %g\t%p\n'
${FIND} -type f -perm /g+s,o+w  -printf '%M %u %g\t%p\n'
${FIND} -type d -perm /a+st,o+w -printf '%M %u %g\t%p\n'

sinfo "Build environment:"
if [ -e ${SRC}/conf/checkregexps ]; then
    regexps=`cat ${SRC}/conf/checkregexps | tr '\n' '|' | sed 's/^/(/; s/|$/)/'`

    chroot ${LIVECD}/../src grep   -iE "${regexps}"         \
        /usr/src/linux/arch/x86/boot/compressed/vmlinux.bin \
        /usr/src/linux-kexec/arch/x86/boot/compressed/vmlinux.bin

    chroot ${LIVECD}        xzgrep -iE "${regexps}" \
        /boot/initrd-x86.xz                         \
        /usr/local/boot/initrd-kexec.xz

    ${FIND} -type f ! -name '*.mo' ! -name 'words.*' ! -name '*.rws' \
        ! -name 'libgucharmap.so.*' ! -name oui.txt -print0 \
        | chroot ${LIVECD} xargs -0 grep -liE "${regexps}"
else
    echo "checkregexp file not found, skipping"
fi

sinfo "Unsupported scripts"
${FIND} -type f -print0  | chroot ${LIVECD} xargs -0 grep -lE \
    '^#![[:blank:]]*/usr/bin/(perl|python|env[[:blank:]]+(perl|python))\>'

true
